# Validkun テスト環境

OpenAPI仕様書に基づいた簡易バックエンドとフロントエンドのテスト環境です。

## 📁 ファイル構成

```
test/
├── openapi.yaml         # OpenAPI 3.0.3 仕様書
├── .spectral.yaml       # OpenAPI仕様書のlintルール設定
├── backend-server.js    # Express製バックエンドサーバー
├── frontend.html        # 自動テスト実行フロントエンド
├── package.json         # Node.js依存関係
└── README.md           # このファイル
```

## 🚀 セットアップと起動

### 1. 依存関係のインストール

```bash
cd test
npm install
```

### 2. OpenAPI仕様書のバリデーション（推奨）

```bash
npm run lint:openapi
```

OpenAPI仕様書が正しく記述されているかチェックします。

### 3. バックエンドサーバーの起動

```bash
npm start
```

サーバーは `http://localhost:3001` で起動します。

### 4. フロントエンドの起動

ブラウザで `frontend.html` を開いてください。

```bash
# macOS
open frontend.html

# Windows
start frontend.html

# Linux
xdg-open frontend.html
```

ページが開いたら：
- **個別実行**: 左側のテストボタン一覧から任意のテストケースをクリックして1つずつ実行
- **一括実行**: 「▶️ 全テスト実行」ボタンをクリックして全テストを連続実行

## ✨ 機能

### バックエンドサーバー

OpenAPI仕様書に定義された全エンドポイントを実装:

#### GET エンドポイント
- `GET /v1/users` - ユーザー一覧取得（ページネーション、フィルタ、ソート対応）
- `GET /v1/users/:userId` - ユーザー詳細取得

#### POST エンドポイント
- `POST /v1/users` - ユーザー作成（バリデーション付き）
- `POST /v1/posts` - 投稿作成

#### PUT エンドポイント
- `PUT /v1/users/:userId` - ユーザー情報完全更新
- `PUT /v1/posts/:postId` - 投稿情報完全更新

#### PATCH エンドポイント
- `PATCH /v1/users/:userId` - ユーザー情報部分更新
- `PATCH /v1/posts/:postId/status` - 投稿ステータス更新
- `PATCH /v1/users/:userId/profile` - ユーザープロフィール更新

#### DELETE エンドポイント
- `DELETE /v1/users/:userId` - ユーザー削除（論理削除/物理削除対応）
- `DELETE /v1/posts/:postId` - 投稿削除
- `DELETE /v1/posts/:postId/comments/:commentId` - コメント削除

### バリデーション機能

以下のバリデーションを実装:

- ✅ メールアドレス形式チェック
- ✅ UUID形式チェック
- ✅ 郵便番号形式チェック（日本の形式: `123-4567`）
- ✅ 電話番号形式チェック（国際形式）
- ✅ 必須フィールドチェック
- ✅ 文字列長チェック
- ✅ 数値範囲チェック
- ✅ Enum値チェック

### フロントエンド

- 🎯 **個別テスト実行**: 各テストケースごとにボタンを配置、1ケースずつ実行可能
- ▶️ **一括テスト実行**: 全テストを連続で実行するボタンも用意
- 📊 **リアルタイム統計**: 成功/失敗のカウントをリアルタイム表示
- 🎨 **2カラムレイアウト**: 左側にテストボタン一覧、右側に結果表示
- ✅ **正常系テスト**: 仕様通りの正しいリクエスト（緑色のボタン）
- ⚠️ **異常系テスト**: バリデーションエラーを引き起こすリクエスト（オレンジ色のボタン）

## 🧪 テストケース

### 正常系テスト例

1. **ユーザー一覧取得** - ページネーション、フィルタ、ソート
2. **ユーザー作成** - 全フィールド正常
3. **投稿作成** - 下書き/公開
4. **ユーザー情報更新** - 完全置換/部分更新
5. **投稿ステータス更新** - 下書き→公開→アーカイブ
6. **プロフィール更新** - SNSリンク、スキル追加
7. **データ削除** - 論理削除/物理削除

### 異常系テスト例

1. **無効なUUID形式** - UUIDとして不正な形式
2. **必須フィールド欠落** - email, name, passwordなど
3. **無効なメール形式** - `@`や`.`がない文字列
4. **パスワード長不足** - 8文字未満
5. **年齢範囲外** - 0未満または150超過
6. **無効な電話番号** - 国際形式に準拠しない
7. **無効な郵便番号** - `123-4567`形式でない
8. **存在しないリソース** - 404エラー
9. **無効なEnum値** - 定義されていないステータス値
10. **空の必須フィールド** - 空文字列

## 📊 テスト結果の見方

フロントエンドでは各リクエストの結果がカードとして表示されます：

- **HTTPメソッド**: GET/POST/PUT/PATCH/DELETE
- **ステータスコード**: 200, 201, 204, 400, 404など
- **テストタイプ**: ✅ 正常系 / ⚠️ 異常系
- **エンドポイント**: リクエストされたURL
- **説明**: テストケースの内容
- **レスポンス**: JSONレスポンス本文

### 期待される結果

#### 正常系テスト
- ステータスコード: `200` (成功), `201` (作成), `204` (削除成功)
- レスポンス: 正常なデータ構造

#### 異常系テスト
- ステータスコード: `400` (バリデーションエラー), `404` (リソース未発見)
- レスポンス: エラーメッセージと詳細情報

```json
{
  "code": "VALIDATION_ERROR",
  "message": "Validation failed",
  "details": [
    {
      "field": "email",
      "message": "Invalid email format"
    }
  ]
}
```

## 🔧 カスタマイズ

### ポート番号の変更

`backend-server.js` の `PORT` 定数を変更:

```javascript
const PORT = 3001; // お好みのポート番号に変更
```

`frontend.html` の `API_BASE_URL` も合わせて変更:

```javascript
const API_BASE_URL = 'http://localhost:3001/v1';
```

### 新しいテストケースの追加

`frontend.html` の `runAllTests()` 関数内に追加:

```javascript
await makeRequest('GET', '/your-endpoint', null, '', 'normal', '説明文');
```

### ダミーデータの変更

`backend-server.js` の `users` と `posts` 配列を編集してください。

## 📝 注意事項

- このサーバーはテスト用の簡易実装です。本番環境では使用しないでください。
- データはメモリ上に保存されるため、サーバーを再起動すると初期状態に戻ります。
- CORS対応済みのため、別のドメインからでもアクセス可能です。
- バリデーションは基本的なものだけを実装しています。

## 🐛 トラブルシューティング

### サーバーが起動しない

- ポート3001が既に使用されていないか確認
- Node.jsがインストールされているか確認（v14以上推奨）
- `npm install` が正常に完了したか確認

### フロントエンドでエラーが出る

- バックエンドサーバーが起動しているか確認
- ブラウザのコンソール（F12）でエラーメッセージを確認
- CORS エラーの場合、バックエンドのCORS設定を確認

### テストが実行されない

- ブラウザのコンソール（F12）でJavaScriptエラーを確認
- ネットワークタブでリクエストが送信されているか確認
- バックエンドのログでリクエストを受信しているか確認

## 📚 参考資料

- [OpenAPI Specification 3.0.3](https://swagger.io/specification/)
- [Express.js Documentation](https://expressjs.com/)
- [Fetch API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)

## 🎯 次のステップ

1. **Chrome拡張機能との連携**: このテスト環境を使ってValidkunの機能をテスト
2. **追加のテストケース**: より複雑なシナリオの追加
3. **自動化**: CI/CDパイプラインへの統合
4. **パフォーマンステスト**: 大量リクエストの負荷テスト

---

Happy Testing! 🐕✨

